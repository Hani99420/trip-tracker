<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GuardianSync | Designed by Hani</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body, html { height: 100%; width: 100%; overflow: hidden; font-family: 'Poppins', sans-serif; background: #000; }

        .page { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; z-index: 10; }
        .active { display: flex; }

        #intro-page { background: radial-gradient(circle at center, #111111 0%, #000000 100%); color: #f5f5f5; }
        .logo-glow { font-size: 4.5rem; margin-bottom: 20px; animation: logoPulse 3s infinite; }
        .main-title { letter-spacing: 8px; font-weight: 400; text-transform: uppercase; font-size: 2rem; color: #fff; }
        .tagline { font-size: 0.75rem; font-weight: 300; color: #475569; letter-spacing: 4px; text-transform: lowercase; margin-top: 5px; margin-bottom: 50px; }
        .btn-elegant { padding: 14px 45px; font-size: 0.8rem; font-weight: 500; color: #22c55e; background: transparent; border: 1px solid #22c55e; border-radius: 2px; cursor: pointer; transition: 0.4s; letter-spacing: 3px; }
        .credit { position: absolute; bottom: 40px; font-size: 0.6rem; color: #1e293b; letter-spacing: 5px; text-transform: uppercase; }

        #map-page { background: #000; }
        #map { height: 100%; width: 100%; background: #000; }
        
        .map-overlay { position: absolute; top: 20px; width: 90%; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .status-badge { background: rgba(0,0,0,0.8); color: #22c55e; padding: 6px 15px; border-radius: 20px; font-size: 0.7rem; border: 1px solid #22c55e; letter-spacing: 1px; }
        .share-btn { background: #22c55e; color: black; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.7rem; pointer-events: auto; cursor: pointer; }

        #qr-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; display: none; z-index: 2000; text-align: center; }

        .custom-marker { display: flex; flex-direction: column; align-items: center; }
        .marker-label { background: rgba(0, 0, 0, 0.9); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; margin-bottom: 5px; white-space: nowrap; border: 1px solid rgba(255,255,255,0.3); }
        .marker-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; position: relative; z-index: 2; }
        .pulse-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; border-radius: 50%; opacity: 0; animation: ringPulse 2s infinite; }

        @keyframes ringPulse { 0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        @keyframes logoPulse { 0% { transform: scale(1); text-shadow: 0 0 10px rgba(34, 197, 94, 0.3); } 50% { transform: scale(1.05); text-shadow: 0 0 30px rgba(34, 197, 94, 0.7); } 100% { transform: scale(1); text-shadow: 0 0 10px rgba(34, 197, 94, 0.3); } }
        .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        /* Ensure zoom controls are visible on dark map */
        .leaflet-control-zoom-in, .leaflet-control-zoom-out { background: #222 !important; color: #22c55e !important; border-color: #444 !important; }
    </style>
</head>
<body>

    <div id="intro-page" class="page active">
        <div class="logo-glow">üõ°Ô∏è</div>
        <h1 class="main-title">GuardianSync</h1>
        <div class="tagline">keep in touch</div>
        <button class="btn-elegant" onclick="launchApp()">OPEN INTERFACE</button>
        <div class="credit">Designed by Hani</div>
    </div>

    <div id="map-page" class="page">
        <div class="map-overlay">
            <div class="status-badge">‚óè LIVE PROTECTION</div>
            <button class="share-btn" onclick="toggleQR()">SHARE QR</button>
        </div>
        <div id="map"></div>
        <div id="qr-modal">
            <div id="qrcode"></div>
            <p style="color:#000; font-size:11px; margin-top:10px; font-weight:bold;">SCAN TO JOIN FAMILY</p>
            <button onclick="toggleQR()" style="margin-top:10px; border:none; background:none; color:red; font-size:12px;">Close</button>
        </div>
    </div>

<script>
    let isFirstPosition = true; // THE FIX: Flag to stop auto-zooming

    function launchApp() {
        const name = prompt("Enter Name to Secure:") || "Explorer";
        document.getElementById('intro-page').classList.remove('active');
        document.getElementById('map-page').classList.add('active');
        startGuardian(name);
    }

    function toggleQR() {
        const qr = document.getElementById('qr-modal');
        qr.style.display = qr.style.display === 'block' ? 'none' : 'block';
    }

    function generateColor(id) {
        const colors = ['#22c55e', '#00d2ff', '#ff007f', '#ffcc00', '#a0fe00', '#ff5e00', '#00ffcc'];
        let hash = 0;
        for (let i = 0; i < id.length; i++) { hash = id.charCodeAt(i) + ((hash << 5) - hash); }
        return colors[Math.abs(hash) % colors.length];
    }

    const firebaseConfig = {
      apiKey: "AIzaSyA2WVIQ3UzX5eF--0qdGX0Xv5rGZY5VcAw",
      authDomain: "location-tracker-6fa7b.firebaseapp.com",
      databaseURL: "https://location-tracker-6fa7b-default-rtdb.firebaseio.com",
      projectId: "location-tracker-6fa7b",
      storageBucket: "location-tracker-6fa7b.firebasestorage.app",
      messagingSenderId: "771776177126",
      appId: "1:771776177126:web:9ead884cf89d828df96c27",
      measurementId: "G-CS9EZWMVZ2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const groupId = location.hash.substring(1) || Math.random().toString(36).substr(2, 6);
    location.hash = groupId;
    const userId = Math.random().toString(36).substr(2, 4);
    const markers = {};

    // Map Setup - ZOOM CONTROL ENABLED
    const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 150, height: 150 });

    function startGuardian(userName) {
        const myColor = generateColor(userId);

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                db.ref(`groups/${groupId}/${userId}`).set({ lat: latitude, lng: longitude, name: userName, color: myColor });
                
                // ONLY SNAP TO POSITION ONCE
                if (isFirstPosition) {
                    map.setView([latitude, longitude], 16);
                    isFirstPosition = false;
                }
            }, null, { enableHighAccuracy: true });
        }

        db.ref(`groups/${groupId}`).on('value', (snapshot) => {
            const users = snapshot.val();
            for (let id in users) {
                const u = users[id];
                const uCol = u.color || '#22c55e';
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-marker"><div class="marker-label" style="border-color: ${uCol}">${u.name}</div><div style="position:relative; width:14px; height:14px;"><div class="pulse-ring" style="border: 3px solid ${uCol}"></div><div class="marker-dot" style="background-color: ${uCol}"></div></div></div>`,
                    iconSize: [40, 50], iconAnchor: [20, 50]
                });
                if (markers[id]) { markers[id].setLatLng([u.lat, u.lng]); markers[id].setIcon(customIcon); } 
                else { markers[id] = L.marker([u.lat, u.lng], { icon: customIcon }).addTo(map); }
            }
        });
    }
</script>
</body>
            </html>
    
